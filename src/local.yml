---
- hosts: localhost
  connection: local
  become: true

  vars:
    container_count: 4
    default_container_name: docker
    default_container_image: ubuntu
    default_container_command: sleep 1

  tasks:
  - name: install base packages
    apt:
      name:
      - htop
      - tmux
      - vim
      - vim-nox
      - python3-psutil
      - vscode

  - name: copy wallpaper file
    copy:
      src: /home/yahya/ansible_desktop/files/terraform.png
      dest: /usr/share/backgrounds/wallpaper.png
      owner: root
      group: root

  - name: set wallpaper
    become_user: yahya
    dconf:
      key: "/org/gnome/desktop/background/picture-uri"
      value: "'file:///usr/share/backgrounds/wallpaper.png'"

  - name: set wallpaper position
    become_user: yahya
    dconf:
      key: "/org/gnome/desktop/background/picture-options"
      value: "'centered'"

  - name: copy .bashrc file
    copy:
      src: /home/yahya/ansible_desktop/files/.bashrc
      dest: /home/yahya/.bashrc
      owner: yahya
      group: yahya

  - name: add ansible user
    user:
      name: puller
      system: yes

  - name: add ansible user to sudoers
    copy:
      src: /home/yahya/ansible_desktop/files/sudoer_puller
      dest: /etc/sudoers.d/puller
      owner: root
      group: root
      mode: 0440

  - name: add ansible-pull cron job
    cron:
      name: ansible auto-provision
      user: puller
      minute: "*/59"
      job: ansible-pull -o -U https://github.com/mmaad18/ansible_desktop.git src/local.yml

  - name: Install aptitude
    apt:
      name: aptitude
      state: latest
      update_cache: true

  - name: Install required system packages
    apt:
      pkg:
      - apt-transport-https
      - ca-certificates
      - curl
      - software-properties-common
      - python3-pip
      - virtualenv
      - python3-setuptools
      state: latest
      update_cache: true

  - name: Add Docker GPG apt Key
    apt_key:
      url: https://download.docker.com/linux/ubuntu/gpg
      state: present

  - name: Add Docker Repository
    apt_repository:
      repo: deb https://download.docker.com/linux/ubuntu jammy stable
      state: present

  - name: Update apt and install docker-ce
    apt:
      name: docker-ce
      state: latest
      update_cache: true

  - name: Install Docker Module for Python
    pip:
      name: docker

  - name: Pull default Docker image
    community.docker.docker_image:
      name: "{{ default_container_image }}"
      source: pull

  - name: Create default containers
    community.docker.docker_container:
      name: "{{ default_container_name }}{{ item }}"
      image: "{{ default_container_image }}"
      command: "{{ default_container_command }}"
      state: present
    with_sequence: count={{ container_count }}
